<script>
    // Initialize Firebase
    firebase.initializeApp({
        databaseURL: "https://performance-dashboard-c7017-default-rtdb.firebaseio.com"
    });

    let dashboardData = null;
    let rawSubmissionsData = null;
    let currentFilter = 'All';
    let currentView = 'performance';

    // ================= TIME FORMATTING HELPERS =================
    function formatPKTTime(isoString) {
        if (!isoString) return 'N/A';
        try {
            const date = new Date(isoString);
            // Add 5 hours for PKT (UTC+5) since backend sends PST (UTC-8)
            const pktDate = new Date(date.getTime() + (13 * 60 * 60 * 1000)); // PST to PKT = +13 hours
            
            return pktDate.toLocaleString('en-US', {
                month: 'short',
                day: 'numeric',
                hour: 'numeric',
                minute: '2-digit',
                hour12: true
            });
        } catch (e) {
            console.error("Error formatting time:", e);
            return 'N/A';
        }
    }

    function formatDateTime(isoString) {
        if (!isoString) return 'N/A';
        try {
            const date = new Date(isoString);
            // Convert PST to PKT (+13 hours)
            const pktDate = new Date(date.getTime() + (13 * 60 * 60 * 1000));
            
            return pktDate.toLocaleString('en-US', {
                month: 'short',
                day: 'numeric',
                hour: 'numeric',
                minute: '2-digit',
                second: '2-digit',
                hour12: true
            });
        } catch (e) {
            console.error("Error formatting date:", e);
            return 'N/A';
        }
    }

    function formatShortTime(isoString) {
        if (!isoString) return '--:--';
        try {
            const date = new Date(isoString);
            const pktDate = new Date(date.getTime() + (13 * 60 * 60 * 1000));
            
            return pktDate.toLocaleString('en-US', {
                hour: 'numeric',
                minute: '2-digit',
                hour12: true
            });
        } catch (e) {
            return '--:--';
        }
    }

    function formatDuration(seconds) {
        if (!seconds || seconds === 0) return "0:00";
        const mins = Math.floor(seconds / 60);
        const secs = Math.floor(seconds % 60);
        return `${mins}:${secs.toString().padStart(2, '0')}`;
    }

    // ================= FILTER MANAGEMENT =================
    function setFilter(filter) {
        currentFilter = filter;
        
        // Update active button
        document.querySelectorAll('.campaign-btn').forEach(btn => {
            btn.classList.remove('active', 'bg-gradient-to-r', 'from-blue-500', 'to-blue-600', 'text-white');
            btn.classList.add('bg-white', 'text-gray-700', 'border', 'border-blue-200');
        });
        
        event.currentTarget.classList.remove('bg-white', 'text-gray-700', 'border', 'border-blue-200');
        event.currentTarget.classList.add('active', 'bg-gradient-to-r', 'from-blue-500', 'to-blue-600', 'text-white');
        
        if (dashboardData) {
            renderAllData();
        }
    }

    // ================= TABLE VIEW MANAGEMENT =================
    function setTableView(view) {
        currentView = view;
        
        // Hide all table views
        document.querySelectorAll('.table-view').forEach(el => {
            el.classList.add('hidden');
        });
        
        // Show selected view
        document.getElementById(`${view}Table`).classList.remove('hidden');
        
        // Update active button
        document.querySelectorAll('.view-btn').forEach(btn => {
            btn.classList.remove('active', 'bg-gradient-to-r', 'from-blue-500', 'to-blue-600', 'text-white');
            btn.classList.add('bg-gray-100', 'text-gray-700', 'border', 'border-gray-300');
        });
        
        event.currentTarget.classList.remove('bg-gray-100', 'text-gray-700', 'border', 'border-gray-300');
        event.currentTarget.classList.add('active', 'bg-gradient-to-r', 'from-blue-500', 'to-blue-600', 'text-white');
        
        // Update title
        const titles = {
            'performance': 'Agent Performance Stats',
            'submissions': 'Live Submissions',
            'dids': 'DID Performance Stats'
        };
        document.getElementById('mainTableTitle').innerHTML = `
            <i class="fas fa-${view === 'performance' ? 'users' : view === 'submissions' ? 'database' : 'phone'} mr-2 text-blue-500"></i>
            ${titles[view]}
        `;
        
        // Render the selected view
        if (dashboardData) {
            switch(view) {
                case 'performance':
                    renderAgents();
                    break;
                case 'dids':
                    renderDIDs();
                    break;
                case 'submissions':
                    renderLiveSubmissions();
                    break;
            }
        }
    }

    // ================= DATA PROCESSING =================
    function processFirebaseData(data) {
        console.log("Processing dashboard data:", data);
        
        return {
            agents: data.agent || {},
            campaigns: data.campaign || {},
            dids: data.dids || {},
            states: data.states || {},
            summary: data.summary || {},
            lastSubmission: data.lastSubmission,
            lastUpdated: data.lastUpdated,
            meta: data.meta || {}
        };
    }

    function calculateFilteredSummary(data, filter) {
        if (filter === 'All') {
            return data.summary || {};
        }
        
        const campaign = data.campaigns[filter];
        if (campaign) {
            return {
                submissions: campaign.submissions || 0,
                qualified: campaign.qualified || 0,
                notQualified: campaign.notQualified || 0,
                pending: campaign.pending || 0,
                callback: campaign.callback || 0,
                fph: campaign.fph || 0,
                sph: campaign.sph || 0,
                avgTalkTime: campaign.avgTalkTime || 0
            };
        }
        
        return {
            submissions: 0,
            qualified: 0,
            notQualified: 0,
            pending: 0,
            callback: 0,
            fph: 0,
            sph: 0,
            avgTalkTime: 0
        };
    }

    function filterAgentsByCampaign(agents, campaignName) {
        if (campaignName === 'All') return agents;
        
        const filtered = {};
        Object.keys(agents).forEach(agentName => {
            const agent = agents[agentName];
            if (agent.campaigns && agent.campaigns.includes(campaignName)) {
                filtered[agentName] = agent;
            }
        });
        
        return filtered;
    }

    // ================= RENDER FUNCTIONS =================
    function renderAllData() {
        if (!dashboardData) return;
        
        // Update time with PKT conversion
        document.getElementById('lastSubmissionTime').textContent = 
            formatPKTTime(dashboardData.lastSubmission) || 'No data yet';

        // Update metrics with filtered data
        const filteredSummary = calculateFilteredSummary(dashboardData, currentFilter);
        
        document.getElementById('submissions').textContent = filteredSummary.submissions || 0;
        document.getElementById('qualified').textContent = filteredSummary.qualified || 0;
        document.getElementById('notQualified').textContent = filteredSummary.notQualified || 0;
        document.getElementById('pending').textContent = filteredSummary.pending || 0;
        document.getElementById('callback').textContent = filteredSummary.callback || 0;
        document.getElementById('fph').textContent = (filteredSummary.fph || 0).toFixed(2);
        document.getElementById('sph').textContent = (filteredSummary.sph || 0).toFixed(2);
        document.getElementById('avgTalkTime').textContent = formatDuration(filteredSummary.avgTalkTime || 0);

        // Render based on current view
        switch(currentView) {
            case 'performance':
                renderAgents();
                break;
            case 'dids':
                renderDIDs();
                break;
            case 'submissions':
                renderLiveSubmissions();
                break;
        }

        // Always render campaigns and states
        renderCampaigns();
        renderTopStates();
    }

    function renderAgents() {
        const tbody = document.getElementById('agentsBody');
        const tfoot = document.getElementById('agentsTotal');
        tbody.innerHTML = '';
        
        const filteredAgents = filterAgentsByCampaign(dashboardData.agents, currentFilter);
        
        if (!filteredAgents || Object.keys(filteredAgents).length === 0) {
            tbody.innerHTML = `
                <tr class="bg-white">
                    <td colspan="7" class="py-8 text-center text-gray-500">
                        <i class="fas fa-users text-2xl mb-2 text-gray-300"></i><br>
                        No agent data available for ${currentFilter}
                    </td>
                </tr>
            `;
            tfoot.innerHTML = '';
            return;
        }
        
        const sortedAgents = Object.entries(filteredAgents)
            .filter(([name]) => name && name !== "undefined")
            .sort((a, b) => (b[1].qualified || 0) - (a[1].qualified || 0));
        
        sortedAgents.forEach(([name, stats], index) => {
            const rowClass = index % 2 === 0 ? 'bg-white' : 'bg-gray-50';
            
            tbody.innerHTML += `
                <tr class="${rowClass} hover:bg-blue-50 transition-colors duration-150">
                    <td class="py-3 px-4 font-medium">
                        <div class="flex items-center">
                            <div class="w-6 h-6 rounded-full bg-blue-100 text-blue-600 flex items-center justify-center font-bold text-xs mr-2">
                                ${index + 1}
                            </div>
                            ${name}
                        </div>
                    </td>
                    <td class="py-3 px-4">${stats.submissions || 0}</td>
                    <td class="py-3 px-4 font-bold text-green-600">${stats.qualified || 0}</td>
                    <td class="py-3 px-4 text-red-500">${stats.notQualified || 0}</td>
                    <td class="py-3 px-4">${(stats.fph || 0).toFixed(2)}</td>
                    <td class="py-3 px-4">${(stats.sph || 0).toFixed(2)}</td>
                    <td class="py-3 px-4">${formatDuration(stats.avgTalkTime || 0)}</td>
                </tr>
            `;
        });
        
        const totalSubmissions = sortedAgents.reduce((sum, [_, stats]) => sum + (stats.submissions || 0), 0);
        const totalQualified = sortedAgents.reduce((sum, [_, stats]) => sum + (stats.qualified || 0), 0);
        const totalNotQualified = sortedAgents.reduce((sum, [_, stats]) => sum + (stats.notQualified || 0), 0);
        const avgFPH = sortedAgents.length > 0 ? 
            (sortedAgents.reduce((sum, [_, stats]) => sum + (stats.fph || 0), 0) / sortedAgents.length).toFixed(2) : '0.00';
        const avgSPH = sortedAgents.length > 0 ? 
            (sortedAgents.reduce((sum, [_, stats]) => sum + (stats.sph || 0), 0) / sortedAgents.length).toFixed(2) : '0.00';
        
        tfoot.innerHTML = `
            <tr>
                <td class="py-3 px-4">TOTALS (${currentFilter})</td>
                <td class="py-3 px-4">${totalSubmissions}</td>
                <td class="py-3 px-4">${totalQualified}</td>
                <td class="py-3 px-4">${totalNotQualified}</td>
                <td class="py-3 px-4">${avgFPH}</td>
                <td class="py-3 px-4">${avgSPH}</td>
                <td class="py-3 px-4"></td>
            </tr>
        `;
    }

    function renderDIDs() {
        const tbody = document.getElementById('didsBody');
        const tfoot = document.getElementById('didsTotal');
        tbody.innerHTML = '';
        
        if (!dashboardData.dids || Object.keys(dashboardData.dids).length === 0) {
            tbody.innerHTML = `
                <tr class="bg-white">
                    <td colspan="7" class="py-8 text-center text-gray-500">
                        <i class="fas fa-phone text-2xl mb-2 text-gray-300"></i><br>
                        No DID data available
                    </td>
                </tr>
            `;
            tfoot.innerHTML = '';
            return;
        }
        
        const sortedDIDs = Object.entries(dashboardData.dids)
            .sort((a, b) => (b[1].qualified || 0) - (a[1].qualified || 0));
        
        sortedDIDs.forEach(([did, stats], index) => {
            const rowClass = index % 2 === 0 ? 'bg-white' : 'bg-gray-50';
            
            tbody.innerHTML += `
                <tr class="${rowClass} hover:bg-purple-50 transition-colors duration-150">
                    <td class="py-3 px-4 font-medium">${did}</td>
                    <td class="py-3 px-4">${stats.campaign || 'N/A'}</td>
                    <td class="py-3 px-4">${stats.submissions || 0}</td>
                    <td class="py-3 px-4 font-bold text-green-600">${stats.qualified || 0}</td>
                    <td class="py-3 px-4 text-red-500">${stats.notQualified || 0}</td>
                    <td class="py-3 px-4">${(stats.fph || 0).toFixed(2)}</td>
                    <td class="py-3 px-4">${(stats.sph || 0).toFixed(2)}</td>
                </tr>
            `;
        });
        
        const totalSubmissions = sortedDIDs.reduce((sum, [_, stats]) => sum + (stats.submissions || 0), 0);
        const totalQualified = sortedDIDs.reduce((sum, [_, stats]) => sum + (stats.qualified || 0), 0);
        const totalNotQualified = sortedDIDs.reduce((sum, [_, stats]) => sum + (stats.notQualified || 0), 0);
        
        tfoot.innerHTML = `
            <tr>
                <td class="py-3 px-4">TOTALS</td>
                <td class="py-3 px-4"></td>
                <td class="py-3 px-4">${totalSubmissions}</td>
                <td class="py-3 px-4">${totalQualified}</td>
                <td class="py-3 px-4">${totalNotQualified}</td>
                <td class="py-3 px-4"></td>
                <td class="py-3 px-4"></td>
            </tr>
        `;
    }

    function renderLiveSubmissions() {
        const tbody = document.getElementById('liveSubmissionsBody');
        tbody.innerHTML = '';
        
        if (!rawSubmissionsData || !rawSubmissionsData.submissions || rawSubmissionsData.submissions.length === 0) {
            tbody.innerHTML = `
                <tr>
                    <td colspan="7" class="py-8 text-center text-gray-500">
                        <i class="fas fa-database text-2xl mb-2 text-gray-300"></i><br>
                        No live submissions data available
                    </td>
                </tr>
            `;
            return;
        }
        
        const submissions = rawSubmissionsData.submissions;
        
        submissions.forEach((sub, index) => {
            const rowClass = index % 2 === 0 ? 'bg-white' : 'bg-gray-50';
            
            tbody.innerHTML += `
                <tr class="${rowClass} hover:bg-blue-50 transition-colors duration-150">
                    <td class="py-3 px-4 text-xs">
                        <div class="font-medium">${formatDateTime(sub.timestamp)}</div>
                        <div class="text-gray-500 text-xs">PKT</div>
                    </td>
                    <td class="py-3 px-4">${sub.agent || 'Unknown'}</td>
                    <td class="py-3 px-4 text-sm font-mono">${sub.did || 'N/A'}</td>
                    <td class="py-3 px-4">
                        <span class="px-2 py-1 bg-blue-100 text-blue-800 rounded text-xs font-medium">
                            ${sub.state || 'N/A'}
                        </span>
                    </td>
                    <td class="py-3 px-4">${sub.campaign || 'Unknown'}</td>
                    <td class="py-3 px-4 font-medium">${formatDuration(sub.duration || 0)}</td>
                    <td class="py-3 px-4">
                        <span class="px-2 py-1 rounded text-xs font-medium ${
                            sub.disposition === 'Qualified' || sub.disposition === 'Enrolled' ? 'bg-green-100 text-green-800' :
                            sub.disposition === 'Not Qualified' ? 'bg-red-100 text-red-800' :
                            sub.disposition === 'Pending' ? 'bg-yellow-100 text-yellow-800' :
                            sub.disposition === 'Call Back' ? 'bg-blue-100 text-blue-800' :
                            'bg-gray-100 text-gray-800'
                        }">
                            ${sub.disposition || 'Unknown'}
                        </span>
                    </td>
                </tr>
            `;
        });
    }

    function renderCampaigns() {
        const tbody = document.getElementById('campaignsBody');
        const tfoot = document.getElementById('campaignsTotal');
        tbody.innerHTML = '';
        
        if (!dashboardData.campaigns || Object.keys(dashboardData.campaigns).length === 0) {
            tbody.innerHTML = `
                <tr class="bg-white">
                    <td colspan="4" class="py-8 text-center text-gray-500">
                        <i class="fas fa-chart-bar text-2xl mb-2 text-gray-300"></i><br>
                        No campaign data available
                    </td>
                </tr>
            `;
            tfoot.innerHTML = '';
            return;
        }
        
        Object.entries(dashboardData.campaigns).forEach(([name, stats], index) => {
            tbody.innerHTML += `
                <tr class="${index % 2 === 0 ? 'bg-white' : 'bg-gray-50'} hover:bg-green-50 transition-colors duration-150">
                    <td class="py-2 px-3 font-medium">${name}</td>
                    <td class="py-2 px-3">${stats.submissions || 0}</td>
                    <td class="py-2 px-3 font-bold text-green-600">${stats.qualified || 0}</td>
                    <td class="py-2 px-3">${(stats.fph || 0).toFixed(2)}</td>
                </tr>
            `;
        });
        
        const summary = dashboardData.summary || {};
        tfoot.innerHTML = `
            <tr>
                <td class="py-2 px-3">TOTALS</td>
                <td class="py-2 px-3">${summary.submissions || 0}</td>
                <td class="py-2 px-3">${summary.qualified || 0}</td>
                <td class="py-2 px-3">${(summary.fph || 0).toFixed(2)}</td>
            </tr>
        `;
    }

    function renderTopStates() {
        const container = document.getElementById('topStatesBody');
        container.innerHTML = '';
        
        if (!dashboardData.states || Object.keys(dashboardData.states).length === 0) {
            container.innerHTML = `
                <div class="col-span-2 text-center py-4 text-gray-500">
                    <i class="fas fa-map text-xl mb-1 text-gray-300"></i><br>
                    <span class="text-sm">No state data</span>
                </div>
            `;
            return;
        }
        
        const sortedStates = Object.entries(dashboardData.states)
            .sort((a, b) => b[1] - a[1])
            .slice(0, 4);
        
        sortedStates.forEach(([state, volume]) => {
            container.innerHTML += `
                <div class="bg-gradient-to-r from-blue-500 to-blue-600 text-white rounded-lg p-3 text-center shadow hover:shadow-md transition-shadow duration-300">
                    <div class="text-xl font-bold mb-1">${volume}</div>
                    <div class="text-xs font-medium">${state}</div>
                </div>
            `;
        });
    }

    function renderStates() {
        const container = document.getElementById('statesBody');
        container.innerHTML = '';
        
        if (!dashboardData.states || Object.keys(dashboardData.states).length === 0) {
            container.innerHTML = `
                <div class="col-span-3 text-center py-8 text-gray-500">
                    <i class="fas fa-map-marked-alt text-2xl mb-2 text-gray-300"></i><br>
                    No state traffic data available
                </div>
            `;
            return;
        }
        
        const sortedStates = Object.entries(dashboardData.states)
            .sort((a, b) => b[1] - a[1]);
        
        const maxVolume = Math.max(...Object.values(dashboardData.states));
        
        sortedStates.forEach(([state, volume]) => {
            const percentage = maxVolume > 0 ? Math.round((volume / maxVolume) * 100) : 0;
            
            container.innerHTML += `
                <div class="bg-white rounded-lg p-3 border border-gray-200 shadow hover:shadow-md transition-all duration-200">
                    <div class="flex justify-between items-start mb-2">
                        <div>
                            <div class="font-bold text-gray-800">${state}</div>
                            <div class="text-xs text-gray-500">State Volume</div>
                        </div>
                        <div class="text-xl font-bold text-blue-600">${volume}</div>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-1.5">
                        <div class="bg-gradient-to-r from-blue-500 to-purple-600 h-1.5 rounded-full" 
                             style="width: ${percentage}%"></div>
                    </div>
                    <div class="text-right text-xs text-gray-500 mt-1">${percentage}% of peak</div>
                </div>
            `;
        });
    }

    // ================= MODAL FUNCTIONS =================
    function openTrafficModal() {
        renderStates();
        document.getElementById('trafficModal').classList.remove('hidden');
        document.getElementById('trafficModal').classList.add('flex');
    }

    function closeTrafficModal() {
        document.getElementById('trafficModal').classList.add('hidden');
        document.getElementById('trafficModal').classList.remove('flex');
    }

    // ================= FIREBASE LISTENERS =================
    firebase.database().ref("dashboard/live").on("value", snapshot => {
        const data = snapshot.val();
        if (data) {
            dashboardData = processFirebaseData(data);
            renderAllData();
        }
    });

    firebase.database().ref("dashboard/raw").on("value", snapshot => {
        const data = snapshot.val();
        if (data) {
            rawSubmissionsData = data;
            if (currentView === 'submissions') {
                renderLiveSubmissions();
            }
        }
    });

    // ================= INITIALIZATION =================
    document.addEventListener('DOMContentLoaded', () => {
        document.querySelector('.campaign-btn.active').click();
        document.querySelector('.view-btn.active').click();
    });

    document.getElementById('trafficModal').addEventListener('click', (e) => {
        if (e.target.id === 'trafficModal') {
            closeTrafficModal();
        }
    });
</script>
